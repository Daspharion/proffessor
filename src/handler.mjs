import Composer from 'telegraf/composer'
import Extra from 'telegraf/extra'
import Actions from './actions'
import Stage from './stage'
import Chat from './chat'

import { Groups, Polls, Schedules, Announcements, Requisites, Users, Visiting, GroupSms, Parents } from './models'

const Handler = new Composer()

Handler.use(Stage)
Handler.use(Actions)

Handler.on('new_chat_members', async ctx => {
  const member = ctx.message.new_chat_participant
  if(ctx.options.id === member.id) {
    ctx.replyWithMarkdown(`–î–æ–±—Ä–æ–≥–æ ${ new Date().getHours() < 18 ? '–¥–Ω—è' : '–≤–µ—á–æ—Ä–∞' }. –ú–µ–Ω–µ –∑–≤–∞—Ç–∏ \`PROFFESSOR\`, —è –±—É–¥—É –¥–æ–ø–æ–º–∞–≥–∞—Ç–∏ *–í–∞–º* ${
      ''}–ø—Ä–æ—Ç—è–≥–æ–º –Ω–∞–≤—á–∞–ª—å–Ω–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—É.\n–î–ª—è –∑–∞–∫—ñ–Ω—á–µ–Ω–Ω—è —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó, –≤–∏–±–µ—Ä—ñ—Ç—å, –±—É–¥—å –ª–∞—Å–∫–∞, —Ç–∏–ø —Ü—ñ—î—ó –±–µ—Å—ñ–¥–∏:`,
      Extra.markup(m => m.inlineKeyboard([
        m.callbackButton('üë®‚Äçüéì –°—Ç—É–¥–µ–Ω—Ç—Å—å–∫–∞', 'reg-student'),
        m.callbackButton('üë©‚Äçüè´ –í–∏–∫–ª–∞–¥–∞—Ü—å–∫–∞', 'reg-teacher')
      ])))
  }
})

Handler.on('left_chat_member', async ctx => {
  const member = ctx.message.left_chat_participant
  if(ctx.options.id === member.id) {
    const group_id = ctx.message.chat.id
    const group = await Groups.findOne({ group_id: group_id })
    if(group) {
      Announcements.remove({ group_id: group_id }).catch(err => console.error(err))
      Requisites.remove({ group_id: group_id }).catch(err => console.error(err))
      Schedules.remove({ group_id: group_id }).catch(err => console.error(err))
      Visiting.remove({ group_id: group_id }).catch(err => console.error(err))
      GroupSms.remove({ group_id: group_id }).catch(err => console.error(err))
      Parents.remove({ group_id: group_id }).catch(err => console.error(err))
      Polls.remove({ group_id: group_id }).catch(err => console.error(err))
      Users.remove({ group_id: group_id }).catch(err => console.error(err))
      Groups.remove({ group_id: group_id }).then(() => {
        group.admins.forEach(admin => {
          ctx.telegram.sendMessage(admin, `–û—Å–∫—ñ–ª—å–∫–∏ –º–µ–Ω–µ –±—É–ª–æ –≤–∏–¥–∞–ª–µ–Ω–æ —ñ–∑ –±–µ—Å—ñ–¥–∏ \`${
            group.group_title }\`, –≤—Å—è —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è —Ç–∞ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –±—É–ª–∏ *—Å—Ç–µ—Ä—Ç—ñ*. –Ø —Å—É–º—É–≤–∞—Ç–∏–º—É –∑–∞ –≤–∞–º–∏ üòî`, Extra.markdown())
          ctx.scene.leave()
        })
      }).catch(err => console.error(err))
    }
  }
})

Handler.command('start', async ctx => {
  if(ctx.message.chat.type === 'private') {
    const groups = await Groups.find({ admins: ctx.message.from.id })
    if(!groups[0]) ctx.replyWithMarkdown('–î–ª—è –ø–æ—á–∞—Ç–∫—É —Ä–æ–±–æ—Ç–∏ –¥–æ–±–∞–≤—Ç–µ –º–µ–Ω–µ, –±—É–¥—å –ª–∞—Å–∫–∞, –≤ *–±–µ—Å—ñ–¥—É* üëãüèª')
    else ctx.replyWithMarkdown(`–ü—Ä–∏–≤—ñ—Ç, ${ ctx.message.from.first_name }, –≤–∏ —î –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º –≥—Ä—É–ø${ groups[1] ? '' : '–∏' } \`${
      groups.map(group => group.group_title).join(', ') }\`. –ß–∏–º —è –º–æ–∂—É –≤–∞–º –¥–æ–ø–æ–º–æ–≥—Ç–∏?`)
  }
  else ctx.replyWithMarkdown(`–í–∏–±–∞—á—Ç–µ, –∞–ª–µ –¥–∞–Ω–∞ –∫–æ–º–∞–Ω–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç—ñ–ª—å–∫–∏ —á–µ—Ä–µ–∑ *–ø—Ä–∏–≤–∞—Ç–Ω—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è*.`)
})

Handler.command('newpoll', async ctx => {
  if(ctx.message.chat.type === 'private') {
    const groups = await Groups.find({ admins: ctx.message.from.id })
    if(groups[0]) {
      if(groups[1]) {
        ctx.scene.enter('getgroup')
        ctx.session.getgroup = { user_id: ctx.message.from.id, next: 'newpoll' }
      } else {
        ctx.scene.enter('newpoll')
        ctx.session.newpoll = { group_id: groups[0].group_id }
      }
    } else ctx.reply(`–í–∏–±–∞—á—Ç–µ, –∞–ª–µ —É –≤–∞—Å –Ω–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ *–ø—Ä–∞–≤* –¥–ª—è —Ü—ñ—î—ó –∫–æ–º–∞–Ω–¥–∏.`)
  } else ctx.replyWithMarkdown(`–í–∏–±–∞—á—Ç–µ, –∞–ª–µ –¥–∞–Ω–∞ –∫–æ–º–∞–Ω–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç—ñ–ª—å–∫–∏ —á–µ—Ä–µ–∑ *–ø—Ä–∏–≤–∞—Ç–Ω—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è*.`)
})

Handler.command('delpoll', async ctx => {
  if(ctx.message.chat.type === 'private')
    Polls.remove({ user_id: ctx.message.from.id })
      .then(({ n }) => ctx.reply(n ? '–û–ø–∏—Ç—É–≤–∞–Ω–Ω—è –±—É–ª–æ —É—Å–ø—ñ—à–Ω–æ –≤–∏–¥–∞–ª–µ–Ω–µ.' : '–£ –≤–∞—Å –Ω–µ–º–∞—î –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –æ–ø–∏—Ç—É–≤–∞–Ω–Ω—è.'))
      .catch(() => ctx.reply('–í—ñ–¥–±—É–ª–∞—Å—å –Ω–µ–≤—ñ–¥–æ–º–∞ –ø–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –≤–∏–¥–∞–ª–µ–Ω–Ω—ñ –æ–ø–∏—Ç—É–≤–∞–Ω–Ω—è.'))
  else ctx.replyWithMarkdown(`–í–∏–±–∞—á—Ç–µ, –∞–ª–µ –¥–∞–Ω–∞ –∫–æ–º–∞–Ω–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç—ñ–ª—å–∫–∏ —á–µ—Ä–µ–∑ *–ø—Ä–∏–≤–∞—Ç–Ω—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è*.`)
})

Handler.command('schedule', async ctx => {
  if(ctx.message.chat.type === 'private') {
    const groups = await Groups.find({ admins: ctx.message.from.id })
    if(groups[0]) {
      if(groups[1]) {
        ctx.scene.enter('getgroup')
        ctx.session.getgroup = { user_id: ctx.message.from.id, next: 'tschedule|schedule' }
      } else {
        const scene = groups[0].type ? 'tschedule' : 'schedule'
        ctx.scene.enter(scene)
        ctx.session[scene] = { group_id: groups[0].group_id }
      }
    } else ctx.replyWithMarkdown(`–í–∏–±–∞—á—Ç–µ, –∞–ª–µ —É –≤–∞—Å –Ω–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ *–ø—Ä–∞–≤* –¥–ª—è —Ü—ñ—î—ó –∫–æ–º–∞–Ω–¥–∏.`)
  } else {
    const group = await Groups.findOne({ group_id: ctx.message.chat.id })
    if(group && !group.type) ctx.scene.enter('groupschedule')
    else ctx.replyWithMarkdown(`–í–∏–±–∞—á—Ç–µ, –∞–ª–µ –∫–æ–º–∞–Ω–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç—ñ–ª—å–∫–∏ –¥–ª—è *—Å—Ç—É–¥–µ–Ω—Ç—ñ–≤*.`)
  }
})

Handler.command('delschedule', async ctx => {
  if(ctx.message.chat.type === 'private') {
    const groups = await Groups.find({ admins: ctx.message.from.id })
    if(groups[0]) {
      if(groups[1]) {
        ctx.scene.enter('getgroup')
        ctx.session.getgroup = { user_id: ctx.message.from.id, next: 'delschedule' }
      } else {
        ctx.scene.enter('delschedule')
        ctx.session.delschedule = { group_id: groups[0].group_id }
      }
    } else ctx.replyWithMarkdown(`–í–∏–±–∞—á—Ç–µ, –∞–ª–µ —É –≤–∞—Å –Ω–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ *–ø—Ä–∞–≤* –¥–ª—è —Ü—ñ—î—ó –∫–æ–º–∞–Ω–¥–∏.`)
  } else ctx.replyWithMarkdown(`–í–∏–±–∞—á—Ç–µ, –∞–ª–µ –¥–∞–Ω–∞ –∫–æ–º–∞–Ω–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç—ñ–ª—å–∫–∏ —á–µ—Ä–µ–∑ *–ø—Ä–∏–≤–∞—Ç–Ω—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è*.`)
})

Handler.command('homework', async ctx => {
  if(ctx.message.chat.type === 'private') {
    const groups = await Groups.find({ admins: ctx.message.from.id, type: false })
    if(groups[0]) {
      if(groups[1]) {
        ctx.scene.enter('getgroup')
        ctx.session.getgroup = { user_id: ctx.message.from.id, next: 'homework', type: false }
      } else {
        ctx.scene.enter('homework')
        ctx.session.homework = { group_id: groups[0].group_id }
      }
    } else ctx.replyWithMarkdown(`–í–∏–±–∞—á—Ç–µ, –∞–ª–µ —É –≤–∞—Å –Ω–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ *–ø—Ä–∞–≤* –¥–ª—è —Ü—ñ—î—ó –∫–æ–º–∞–Ω–¥–∏.`)
  } else ctx.replyWithMarkdown(`–í–∏–±–∞—á—Ç–µ, –∞–ª–µ –¥–∞–Ω–∞ –∫–æ–º–∞–Ω–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç—ñ–ª—å–∫–∏ —á–µ—Ä–µ–∑ *–ø—Ä–∏–≤–∞—Ç–Ω—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è*.`)
})

Handler.command('announce', async ctx => {
  if(ctx.message.chat.type === 'private') {
    const groups = await Groups.find({ admins: ctx.message.from.id })
    if(groups[0]) {
      if(groups[1]) {
        ctx.scene.enter('getgroup')
        ctx.session.getgroup = { user_id: ctx.message.from.id, next: 'announce' }
      } else {
        ctx.scene.enter('announce')
        ctx.session.announce = { group_id: groups[0].group_id }
      }
    } else ctx.replyWithMarkdown(`–í–∏–±–∞—á—Ç–µ, –∞–ª–µ —É –≤–∞—Å –Ω–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ *–ø—Ä–∞–≤* –¥–ª—è —Ü—ñ—î—ó –∫–æ–º–∞–Ω–¥–∏.`)
  } else ctx.replyWithMarkdown(`–í–∏–±–∞—á—Ç–µ, –∞–ª–µ –¥–∞–Ω–∞ –∫–æ–º–∞–Ω–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç—ñ–ª—å–∫–∏ —á–µ—Ä–µ–∑ *–ø—Ä–∏–≤–∞—Ç–Ω—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è*.`)
})

Handler.command('money', async ctx => {
  if(ctx.message.chat.type === 'private') {
    const groups = await Groups.find({ admins: ctx.message.from.id })
    if(groups[0]) {
      if(groups[1]) {
        ctx.scene.enter('getgroup')
        ctx.session.getgroup = { user_id: ctx.message.from.id, next: 'money' }
      } else {
        ctx.scene.enter('money')
        ctx.session.money = { group_id: groups[0].group_id }
      }
    } else ctx.replyWithMarkdown(`–í–∏–±–∞—á—Ç–µ, –∞–ª–µ —É –≤–∞—Å –Ω–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ *–ø—Ä–∞–≤* –¥–ª—è —Ü—ñ—î—ó –∫–æ–º–∞–Ω–¥–∏.`)
  } else ctx.replyWithMarkdown(`–í–∏–±–∞—á—Ç–µ, –∞–ª–µ –¥–∞–Ω–∞ –∫–æ–º–∞–Ω–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç—ñ–ª—å–∫–∏ —á–µ—Ä–µ–∑ *–ø—Ä–∏–≤–∞—Ç–Ω—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è*.`)
})

Handler.command('requisites', async ctx => {
  if(ctx.message.chat.type === 'private') {
    const groups = await Groups.find({ admins: ctx.message.from.id })
    if(groups[0]) {
      if(groups[1]) {
        ctx.scene.enter('getgroup')
        ctx.session.getgroup = { user_id: ctx.message.from.id, next: 'requisites' }
      } else {
        ctx.scene.enter('requisites')
        ctx.session.requisites = { group_id: groups[0].group_id }
      }
    } else ctx.replyWithMarkdown(`–í–∏–±–∞—á—Ç–µ, –∞–ª–µ —É –≤–∞—Å –Ω–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ *–ø—Ä–∞–≤* –¥–ª—è —Ü—ñ—î—ó –∫–æ–º–∞–Ω–¥–∏.`)
  } else ctx.replyWithMarkdown(`–í–∏–±–∞—á—Ç–µ, –∞–ª–µ –¥–∞–Ω–∞ –∫–æ–º–∞–Ω–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç—ñ–ª—å–∫–∏ —á–µ—Ä–µ–∑ *–ø—Ä–∏–≤–∞—Ç–Ω—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è*.`)
})

Handler.command('adduser', async ctx => {
  if(ctx.message.chat.type === 'private') {
    const groups = await Groups.find({ admins: ctx.message.from.id })
    if(groups[0]) {
      if(groups[1]) {
        ctx.scene.enter('getgroup')
        ctx.session.getgroup = { user_id: ctx.message.from.id, next: 'adduser' }
      } else {
        ctx.scene.enter('adduser')
        ctx.session.adduser = { group_id: groups[0].group_id }
      }
    } else ctx.replyWithMarkdown(`–í–∏–±–∞—á—Ç–µ, –∞–ª–µ —É –≤–∞—Å –Ω–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ *–ø—Ä–∞–≤* –¥–ª—è —Ü—ñ—î—ó –∫–æ–º–∞–Ω–¥–∏.`)
  } else ctx.replyWithMarkdown(`–í–∏–±–∞—á—Ç–µ, –∞–ª–µ –¥–∞–Ω–∞ –∫–æ–º–∞–Ω–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç—ñ–ª—å–∫–∏ —á–µ—Ä–µ–∑ *–ø—Ä–∏–≤–∞—Ç–Ω—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è*.`)
})

Handler.command('deluser', async ctx => {
  if(ctx.message.chat.type === 'private') {
    const groups = await Groups.find({ admins: ctx.message.from.id })
    if(groups[0]) {
      if(groups[1]) {
        ctx.scene.enter('getgroup')
        ctx.session.getgroup = { user_id: ctx.message.from.id, next: 'deluser' }
      } else {
        ctx.scene.enter('deluser')
        ctx.session.deluser = { group_id: groups[0].group_id }
      }
    } else ctx.replyWithMarkdown(`–í–∏–±–∞—á—Ç–µ, –∞–ª–µ —É –≤–∞—Å –Ω–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ *–ø—Ä–∞–≤* –¥–ª—è —Ü—ñ—î—ó –∫–æ–º–∞–Ω–¥–∏.`)
  } else ctx.replyWithMarkdown(`–í–∏–±–∞—á—Ç–µ, –∞–ª–µ –¥–∞–Ω–∞ –∫–æ–º–∞–Ω–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç—ñ–ª—å–∫–∏ —á–µ—Ä–µ–∑ *–ø—Ä–∏–≤–∞—Ç–Ω—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è*.`)
})

Handler.command('absent', async ctx => {
  if(ctx.message.chat.type === 'private') {
    const groups = await Groups.find({ admins: ctx.message.from.id, type: false })
    if(groups[0]) {
      if(groups[1]) {
        ctx.scene.enter('getgroup')
        ctx.session.getgroup = { user_id: ctx.message.from.id, next: 'absent', type: false }
      } else {
        ctx.scene.enter('absent')
        ctx.session.absent = { group_id: groups[0].group_id }
      }
    } else ctx.replyWithMarkdown(`–í–∏–±–∞—á—Ç–µ, –∞–ª–µ —É –≤–∞—Å –Ω–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ *–ø—Ä–∞–≤* –¥–ª—è —Ü—ñ—î—ó –∫–æ–º–∞–Ω–¥–∏.`)
  } else ctx.replyWithMarkdown(`–í–∏–±–∞—á—Ç–µ, –∞–ª–µ –¥–∞–Ω–∞ –∫–æ–º–∞–Ω–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç—ñ–ª—å–∫–∏ —á–µ—Ä–µ–∑ *–ø—Ä–∏–≤–∞—Ç–Ω—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è*.`)
})

Handler.command('visiting', async ctx => {
  if(ctx.message.chat.type === 'private') {
    const groups = await Groups.find({ admins: ctx.message.from.id, type: false })
    if(groups[0]) {
      if(groups[1]) {
        ctx.scene.enter('getgroup')
        ctx.session.getgroup = { user_id: ctx.message.from.id, next: 'visiting', type: false }
      } else {
        ctx.scene.enter('visiting')
        ctx.session.visiting = { group_id: groups[0].group_id }
      }
    } else ctx.replyWithMarkdown(`–í–∏–±–∞—á—Ç–µ, –∞–ª–µ —É –≤–∞—Å –Ω–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ *–ø—Ä–∞–≤* –¥–ª—è —Ü—ñ—î—ó –∫–æ–º–∞–Ω–¥–∏.`)
  } else ctx.replyWithMarkdown(`–í–∏–±–∞—á—Ç–µ, –∞–ª–µ –¥–∞–Ω–∞ –∫–æ–º–∞–Ω–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç—ñ–ª—å–∫–∏ —á–µ—Ä–µ–∑ *–ø—Ä–∏–≤–∞—Ç–Ω—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è*.`)
})

Handler.command('addparents', async ctx => {
  if(ctx.message.chat.type === 'private') {
    const groups = await Groups.find({ admins: ctx.message.from.id, type: false })
    if(groups[0]) {
      if(groups[1]) {
        ctx.scene.enter('getgroup')
        ctx.session.getgroup = { user_id: ctx.message.from.id, next: 'addparents', type: false }
      } else {
        ctx.scene.enter('addparents')
        ctx.session.addparents = { group_id: groups[0].group_id }
      }
    } else ctx.replyWithMarkdown(`–í–∏–±–∞—á—Ç–µ, –∞–ª–µ —É –≤–∞—Å –Ω–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ *–ø—Ä–∞–≤* –¥–ª—è —Ü—ñ—î—ó –∫–æ–º–∞–Ω–¥–∏.`)
  } else ctx.replyWithMarkdown(`–í–∏–±–∞—á—Ç–µ, –∞–ª–µ –¥–∞–Ω–∞ –∫–æ–º–∞–Ω–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç—ñ–ª—å–∫–∏ —á–µ—Ä–µ–∑ *–ø—Ä–∏–≤–∞—Ç–Ω—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è*.`)
})

Handler.command('badgrade', async ctx => {
  if(ctx.message.chat.type === 'private') {
    const groups = await Groups.find({ admins: ctx.message.from.id })
    if(groups[0]) {
      if(groups[1]) {
        ctx.scene.enter('getgroup')
        ctx.session.getgroup = { user_id: ctx.message.from.id, next: 'tbadgrade|badgrade' }
      } else {
        const scene = groups[0] ? 'tbadgrade' : 'badgrade'
        ctx.scene.enter(scene)
        ctx.session[scene] = { group_id: groups[0].group_id }
      }
    } else ctx.replyWithMarkdown(`–í–∏–±–∞—á—Ç–µ, –∞–ª–µ —É –≤–∞—Å –Ω–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ *–ø—Ä–∞–≤* –¥–ª—è —Ü—ñ—î—ó –∫–æ–º–∞–Ω–¥–∏.`)
  } else ctx.replyWithMarkdown(`–í–∏–±–∞—á—Ç–µ, –∞–ª–µ –¥–∞–Ω–∞ –∫–æ–º–∞–Ω–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç—ñ–ª—å–∫–∏ —á–µ—Ä–µ–∑ *–ø—Ä–∏–≤–∞—Ç–Ω—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è*.`)
})

Handler.command('smsstatus', async ctx => {
  if(ctx.message.chat.type === 'private') {
    const groups = await Groups.find({ admins: ctx.message.from.id })
    if(groups[0]) {
      if(groups[1]) {
        ctx.scene.enter('getgroup')
        ctx.session.getgroup = { user_id: ctx.message.from.id, next: 'smsstatus' }
      } else {
        ctx.scene.enter('smsstatus')
        ctx.session.smsstatus = { group_id: groups[0].group_id }
      }
    } else ctx.replyWithMarkdown(`–í–∏–±–∞—á—Ç–µ, –∞–ª–µ —É –≤–∞—Å –Ω–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ *–ø—Ä–∞–≤* –¥–ª—è —Ü—ñ—î—ó –∫–æ–º–∞–Ω–¥–∏.`)
  } else ctx.replyWithMarkdown(`–í–∏–±–∞—á—Ç–µ, –∞–ª–µ –¥–∞–Ω–∞ –∫–æ–º–∞–Ω–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç—ñ–ª—å–∫–∏ —á–µ—Ä–µ–∑ *–ø—Ä–∏–≤–∞—Ç–Ω—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è*.`)
})

Handler.command('updateadmins', async ctx => {
  if(ctx.message.chat.type === 'group') {
    const admins = (await ctx.getChatAdministrators()).map(({ user }) => user.id)
    const update = await Groups.update({ group_id: ctx.message.chat.id }, { admins: admins })
    ctx.replyWithMarkdown(update.nModified ? '–ê–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä—ñ–≤ *—É—Å–ø—ñ—à–Ω–æ* –æ–Ω–æ–≤–ª–µ–Ω–æ' : '–ó–º—ñ–Ω *–Ω–µ –≤—ñ–¥–±—É–ª–æ—Å—è*')
  } else ctx.replyWithMarkdown(`–í–∏–±–∞—á—Ç–µ, –∞–ª–µ –¥–∞–Ω–∞ –∫–æ–º–∞–Ω–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç—ñ–ª—å–∫–∏ –≤ *–±–µ—Å—ñ–¥—ñ*.`)
})

Handler.command('addgroup', async ctx => {
  if(ctx.message.chat.type === 'private') {
    const groups = await Groups.find({ admins: ctx.message.from.id, type: true })
    if(groups[0]) {
      if(groups[1]) {
        ctx.scene.enter('getgroup')
        ctx.session.getgroup = { user_id: ctx.message.from.id, next: 'addgroup', type: true }
      } else {
        ctx.scene.enter('addgroup')
        ctx.session.addgroup = { group_id: groups[0].group_id }
      }
    } else ctx.replyWithMarkdown(`–í–∏–±–∞—á—Ç–µ, –∞–ª–µ —É –≤–∞—Å –Ω–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ *–ø—Ä–∞–≤* –¥–ª—è —Ü—ñ—î—ó –∫–æ–º–∞–Ω–¥–∏.`)
  } else ctx.replyWithMarkdown(`–í–∏–±–∞—á—Ç–µ, –∞–ª–µ –¥–∞–Ω–∞ –∫–æ–º–∞–Ω–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç—ñ–ª—å–∫–∏ —á–µ—Ä–µ–∑ *–ø—Ä–∏–≤–∞—Ç–Ω—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è*.`)
})

Handler.command('delgroup', async ctx => {
  if(ctx.message.chat.type === 'private') {
    const groups = await Groups.find({ admins: ctx.message.from.id, type: true })
    if(groups[0]) {
      if(groups[1]) {
        ctx.scene.enter('getgroup')
        ctx.session.getgroup = { user_id: ctx.message.from.id, next: 'delgroup', type: true }
      } else {
        ctx.scene.enter('delgroup')
        ctx.session.delgroup = { group_id: groups[0].group_id }
      }
    } else ctx.replyWithMarkdown(`–í–∏–±–∞—á—Ç–µ, –∞–ª–µ —É –≤–∞—Å –Ω–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ *–ø—Ä–∞–≤* –¥–ª—è —Ü—ñ—î—ó –∫–æ–º–∞–Ω–¥–∏.`)
  } else ctx.replyWithMarkdown(`–í–∏–±–∞—á—Ç–µ, –∞–ª–µ –¥–∞–Ω–∞ –∫–æ–º–∞–Ω–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç—ñ–ª—å–∫–∏ —á–µ—Ä–µ–∑ *–ø—Ä–∏–≤–∞—Ç–Ω—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è*.`)
})

Handler.command('docs', async ctx => {
  if(ctx.message.chat.type === 'private') {
    const groups = await Groups.find({ admins: ctx.message.from.id })
    if(groups[0]) {
      if(groups[1]) {
        ctx.scene.enter('getgroup')
        ctx.session.getgroup = { user_id: ctx.message.from.id, next: 'tdocs|docs' }
      } else {
        const scene = groups[0] ? 'tdocs' : 'docs'
        ctx.scene.enter(scene)
        ctx.session[scene] = { group_id: groups[0].group_id }
      }
    } else ctx.replyWithMarkdown(`–í–∏–±–∞—á—Ç–µ, –∞–ª–µ —É –≤–∞—Å –Ω–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ *–ø—Ä–∞–≤* –¥–ª—è —Ü—ñ—î—ó –∫–æ–º–∞–Ω–¥–∏.`)
  } else ctx.replyWithMarkdown(`–í–∏–±–∞—á—Ç–µ, –∞–ª–µ –¥–∞–Ω–∞ –∫–æ–º–∞–Ω–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç—ñ–ª—å–∫–∏ —á–µ—Ä–µ–∑ *–ø—Ä–∏–≤–∞—Ç–Ω—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è*.`)
})

Handler.command('link', async ctx => {
  if(ctx.message.chat.type === 'private') {
    const groups = await Groups.find({ admins: ctx.message.from.id })
    if(groups[0]) {
      if(groups[1]) {
        ctx.scene.enter('getgroup')
        ctx.session.getgroup = { user_id: ctx.message.from.id, next: 'tlink|link' }
      } else {
        const scene = groups[0] ? 'tlink' : 'link'
        ctx.scene.enter(scene)
        ctx.session[scene] = { group_id: groups[0].group_id }
      }
    } else ctx.replyWithMarkdown(`–í–∏–±–∞—á—Ç–µ, –∞–ª–µ —É –≤–∞—Å –Ω–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ *–ø—Ä–∞–≤* –¥–ª—è —Ü—ñ—î—ó –∫–æ–º–∞–Ω–¥–∏.`)
  } else ctx.replyWithMarkdown(`–í–∏–±–∞—á—Ç–µ, –∞–ª–µ –¥–∞–Ω–∞ –∫–æ–º–∞–Ω–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç—ñ–ª—å–∫–∏ —á–µ—Ä–µ–∑ *–ø—Ä–∏–≤–∞—Ç–Ω—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è*.`)
})

Handler.hears(Chat.lstnr, ctx => {
  const msg = ctx.message
  const pattern = Chat.parse(ctx.match[0])
  const str = Chat.reply(pattern, { id: msg.from.id, date: msg.date })
  ctx.reply(str)
})


export default Handler
